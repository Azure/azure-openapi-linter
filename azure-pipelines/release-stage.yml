parameters:
  - name: Version
    type: string
    default: 'staging'
    values:
      - 'staging'
      - 'prod'

stages:
  - stage: Release
    displayName: Release ${{ parameters.Version }}
    dependsOn: Build

    variables:
      - template: /eng/templates/variables/image.yml

    jobs:
      - deployment: Publish
        environment: 'package-publish'
        pool:
          name: azsdk-pool-mms-ubuntu-2004-general
          image: azsdk-pool-mms-ubuntu-2004-1espt
          os: linux

        strategy:
          runOnce:
            deploy:
              steps:
              - checkout: self
                submodules: false

              - download: current
                artifact: oav
                timeoutInMinutes: 5

              - task: PowerShell@2
                inputs:
                  filePath: '$(Build.SourcesDirectory)/eng/scripts/determine-release-tag.ps1'
                  failOnStderr: true
                  pwsh: true

              - pwsh: |
                  Write-Host "Will deploy with tag of $(Tag)"
                  Get-ChildItem "$(Pipeline.Workspace)/oav" -Recurse -Force `
                    | Where-Object { $_.Name -like "*.tgz" } `
                    | Copy-Item -Destination "$(Build.ArtifactStagingDirectory)"

                  Get-ChildItem "$(Build.ArtifactStagingDirectory)" -Recurse -Force | % { Write-Host $_.FullName }
                displayName: Move artifact to $(Build.ArtifactStagingDirectory)
